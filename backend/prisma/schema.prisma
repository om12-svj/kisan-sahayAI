// Prisma Schema for KISAN SAHAY - Farmer Mental Health Support System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // URL is now configured in prisma.config.ts
}

// ============================================
// ENUMS
// ============================================

enum FarmerStatus {
  active
  inactive
  critical_watch
}

enum Language {
  mr // Marathi
  hi // Hindi
  en // English
  te // Telugu
  kn // Kannada
  pa // Punjabi
  gu // Gujarati
  bn // Bengali
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum AlertStatus {
  pending
  acknowledged
  resolved
  escalated
}

enum AlertSeverity {
  high
  critical
}

enum AdminRole {
  SUPER_ADMIN
  DISTRICT_ADMIN
  COUNSELOR
}

// ============================================
// MODELS
// ============================================

model Farmer {
  id           String       @id @default(cuid())
  mobile       String       @unique
  passwordHash String?      @map("password_hash")
  name         String
  village      String
  taluka       String
  district     String
  farmSize     Float        @map("farm_size")
  preferredLang Language    @default(mr) @map("preferred_lang")
  status       FarmerStatus @default(active)
  isOTPUser    Boolean      @default(false) @map("is_otp_user")

  // Counselor assignment
  assignedCounselor AdminUser? @relation("CounselorFarmers", fields: [counselorId], references: [id])
  counselorId       String?    @map("counselor_id")

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Relations
  checkIns      CheckIn[]
  alerts        Alert[]
  refreshTokens RefreshToken[]

  @@index([district])
  @@index([taluka])
  @@index([status])
  @@index([counselorId])
  @@map("farmers")
}

model CheckIn {
  id       String   @id @default(cuid())
  farmer   Farmer   @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  farmerId String   @map("farmer_id")

  timestamp DateTime @default(now())

  // Assessment inputs
  cropCondition String @map("crop_condition")
  loanPressure  String @map("loan_pressure")
  sleepQuality  String @map("sleep_quality")
  familySupport String @map("family_support")
  hopeLevel     Int    @map("hope_level")
  notes         String?

  // Computed results
  riskScore       Int       @map("risk_score")
  riskLevel       RiskLevel @map("risk_level")
  criticalFactors String    @map("critical_factors") // JSON string for SQLite compatibility

  // Tracking
  responseGenerated Boolean @default(true) @map("response_generated")
  alertTriggered    Boolean @default(false) @map("alert_triggered")
  counselorNotified Boolean @default(false) @map("counselor_notified")

  createdAt DateTime @default(now()) @map("created_at")

  alerts Alert[]

  @@index([farmerId])
  @@index([timestamp])
  @@index([riskLevel])
  @@map("check_ins")
}

model Alert {
  id String @id @default(cuid())

  farmer   Farmer @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  farmerId String @map("farmer_id")

  checkIn   CheckIn @relation(fields: [checkInId], references: [id], onDelete: Cascade)
  checkInId String  @map("check_in_id")

  severity AlertSeverity
  status   AlertStatus   @default(pending)

  assignedTo   AdminUser? @relation(fields: [assignedToId], references: [id])
  assignedToId String?    @map("assigned_to_id")

  createdAt      DateTime  @default(now()) @map("created_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  resolvedAt     DateTime? @map("resolved_at")
  resolution     String?

  @@index([status])
  @@index([severity])
  @@index([farmerId])
  @@index([assignedToId])
  @@map("alerts")
}

model AdminUser {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  role         AdminRole
  district     String?
  isActive     Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  assignedFarmers Farmer[]       @relation("CounselorFarmers")
  assignedAlerts  Alert[]
  refreshTokens   RefreshToken[]

  @@index([role])
  @@index([district])
  @@map("admin_users")
}

model RefreshToken {
  id        String @id @default(cuid())
  tokenHash String @unique @map("token_hash")

  // Polymorphic relation - one of these will be set
  farmer   Farmer? @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  farmerId String? @map("farmer_id")

  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  adminUserId String?    @map("admin_user_id")

  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model OTPLog {
  id        String   @id @default(cuid())
  mobile    String
  otpHash   String   @map("otp_hash")
  channel   String // 'sms' or 'whatsapp'
  expiresAt DateTime @map("expires_at")
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([mobile, expiresAt])
  @@map("otp_logs")
}
